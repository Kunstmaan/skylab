steps:
  - ssh-keyscan -p %deploy_port% %deploy_ssh-keyscan_server% >> %home%/.ssh/known_hosts
  - ssh %deploy_server% -p %deploy_port% "sudo mkdir -p %projects_path%/%deploy_project%/data/builds/"
  - ssh %deploy_server% -p %deploy_port% "sudo chown -R %deploy_project%:%deploy_project% %projects_path%/%deploy_project%/data/builds/"
  - ssh %deploy_server% -p %deploy_port% "sudo setfacl -R -m user::rwX %projects_path%/%deploy_project%/data/builds/"
  - ssh %deploy_server% -p %deploy_port% "sudo setfacl -R -m group::r-X %projects_path%/%deploy_project%/data/builds/"
  - ssh %deploy_server% -p %deploy_port% "sudo setfacl -R -m other::--- %projects_path%/%deploy_project%/data/builds/"
  - ssh %deploy_server% -p %deploy_port% "sudo setfacl -R -m u:www-data:r-X %projects_path%/%deploy_project%/data/builds/"
  - ssh %deploy_server% -p %deploy_port% "sudo setfacl -R -m u:%deploy_project%:rwX %projects_path%/%deploy_project%/data/builds/"
  - ssh %deploy_server% -p %deploy_port% "if id -u postgres > /dev/null 2>&1; then sudo setfacl -R -m u:postgres:r-X %projects_path%/%deploy_project%/data/builds/; fi"
  - ssh %deploy_server% -p %deploy_port% "sudo setfacl -R -m user:%deploy_user%:rwX %projects_path%/%deploy_project%/data/builds/"
  - rsync -qahL --progress --rsh=/usr/bin/ssh -e "ssh -p %deploy_port%" %shared_package_folder%//%job_name%-%buildtag%.tar.gz %deploy_server%:%projects_path%/%deploy_project%/data/builds/rsync
  - if [ "yes" = "%remove_shared_package%" ]; then rm %shared_package_folder%//%job_name%-%buildtag%.tar.gz; fi
  - ssh %deploy_server% -p %deploy_port% "cp %projects_path%/%deploy_project%/data/builds/rsync %projects_path%/%deploy_project%/data/builds/%job_name%-%buildtag%.tar.gz"
  - ssh %deploy_server% -p %deploy_port% "sudo chown -R %deploy_project%:%deploy_project% %projects_path%/%deploy_project%/data/builds/"